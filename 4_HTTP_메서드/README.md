# 4. HTTP 메서드

- HTTP API를 만들어 보자!
- GET, POST / PUH, PATCH, DELETE
- 메서드의 속성

## HTTP API 만들기

요구사항에 맞춰 URI을 설계해보자.

### 요구사항

- 회원 목록 조회
- 회원 조회
- 회원 등록
- 회원 수정
- 회원 삭제

```text
🔥 Bad
/read-member-list
/read-member-by-id
/create-member
/update-member
/delete-member

👍 Good
/members
/members/{id}
/members/{id}
/members/{id}
/members/{id}
```

**가장 중요한 것은 리소스 식별이다.** URI 설계의 기준은 리소스가 되야한다.

> 물론 이상적인 방법만으로 해결하지 못하는 경우도 있다.

### API URI 고민

URI(Uniform Resource Identifier)

- 리소스의 의미는 무엇일까?
    - 회원을 등록, 수정, 조회하는 것은 리소스가 아니다.
    - 동작이 아닌 개념 자체가 리소스다.
    - 예) 챔피언을 픽했다. 리소스: 챔피언
- 리소스를 어떻게 식별하면 좋을까?
    - 등록, 수정, 조회하는 행위를 배제한다.
    - **회원이라는 리소스만 식별하면 된다.** / 회원 리소스를 URI에 매핑

주의할 점은 계층 구조상 상위를 컬렉션으로 보기 때문에 복수단어 사용이 권장된다. (member -> members)

### 리소스와 행위를 분리하자

리소스는 식별하는 문제는 해결되었다. 하지만 설계된 URI를 보면 `member/{id}`  무엇이 조회, 삭제인지 알 수 없다.
URI는 리소스를 기준으로 설계하고, 행위는 HTTP 메서드에서 표현한다.

- 리소스와 해당 리소스를 대상으로 하는 행위를 분리
    - 리소스: 회원
    - 행위: 조회, 등록, 삭제, 변경
- 리소스는 명사다. 행위는 동사다.

## HTTP 메서드

HTTP 메서드는 클라이언트가 서버에 요청시 기대하는 행동을 말한다.

### 주요 메서드

- GET: 리소스 조회
- POST: 요청 데이터 처리, 주로 등록에 사용
- PUT: 리소스를 대체, 해당 리소스가 없으면 생성
- PATCH: 리소스 부분 변경
- DELETE: 리소스 삭제

> 리소스라고 표현되었지만 최근에는 Representation(표현)이라는 용어를 사용한다.

### 기타 메서드

- HEAD: GET과 동일하지만 메시지 부분을 제외하고, 상태줄과 헤더만 반환
- OPTIONS: 대상 리소스에 대한 통신 가능 옵션(메서드)을 설명(주로 [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)에서 사용)
- 거의사용하지 않음
    - CONNECT: 대상 자원으로 식별되는 서버에 대한 터널을 설정
    - TRACE: 대상 리소스에 대한 경로를 따라 메시지 루프백 테스트를 실행

### GET

```text
GET /search?q=hello&hl=ko HTTP/1.1
Host: www.google.com
```

- 리소스 조회
- 서버에 전달하고 싶은 데이터를 query(쿼리 파라미터, 쿼리 스트링)에 담아 전달한다.
    - 메시지 바디를 사용해서 데이터를 전달할 수 있지만, 지원하지 않는 곳이 많아 권장하지 않는다.

### POST

```text
POST /members HTTP/1.1
Content-Type: application/json

{
    "username":"유재석",
    "broadcast":"유 퀴즈 온 더 블럭" 
}
```

- 데이터 처리를 서버에 요청한다.
- **메시지 바디를 통해 서버로 요청 데이터 전달**
- 서버는 요청 데이터를 처리
    - 메시지 바디를 통해 들어온 데이터를 처리하는 모든 기능을 수행한다.
- 주로 전달된 데이터로 신규 리소스 등록, 프로세스 처리에 사용된다.


- 요청 데이터를 어떻게 처리한다는 의미일까?
    - 스펙: 대상 리소스가 리소스 고유의 의미체계에 따라 요청에 포함된 표현을 처리하도록 요청한다.
    - 예시
        - HTML 양식에 입력 된 필드와 같은 데이터 블록을 데이터 처리 프로세스에 제공
            - 회원가입, 주문등에서 사용
        - 게시판, 뉴스, 메일링 리스트, 블로그 또는 유사한 기사 그룹에 메시지 표시
            - 게시판 글쓰기, 댓글
        - 서버가 식별하지 않은 리소스 생성
            - 신규 주문 생성
        - 기존 자원에 데이터 추가
            - 문서 끝에 내용 추가하기


- 정리: POST 요청이 오면 요청 데이터를 어떻게 처리할지 리소스마다 따로 정의해야 한다.
    1. 새 리소스 생성(등록): 서버에서 아직 식별되지 않은 리소스 생성
    2. 요청 데이터 처리: 단순히 데이터를 생성, 변경하는 것을 넘어 프로세스 처리
        - 예) 주문에서 결제완료 -> 배달 시작 -> 배달 완료 처럼 값 변경을 넘어 프로세스 변경되는 경우
        - POST의 결과로 새로운 리소스가 생성되지 않을 수도 있다.
        - 예) POST /(컨트롤 URI)
    3. 다른 메서드로 처리하기 애매한 경우
        - 예) JSON으로 조회 데이터를 넘겨야 할 때 `GET`메서드를 사용하기 어려운 경우
        - 애매하면 POST

> 기본적으로 리소스로 최대한 URI를 설계하되 어쩔 수 없는 부분들은 컨트롤 URI로 설계한다.

POST는 만능이다. 하지만 목적에 맞게 사용하는 것을 권장한다. 예를 들어 조회는 GET을 사용하면 된다. 어쩔 수 없는
경우에는 POST를 사용하여 문제를 해결할 수 있다.

### PUT

```text
PUT /members/100 HTTP/1.1
Content-Type: application/json

{
    "username":"유재석",
    "broadcast":"유 퀴즈 온 더 블럭" 
}
```

- 리소스를 대체
    - 리소스가 있으면 **완전히** 대체
    - 리소스가 없으면 생성
    - 덮어버린다.
- 중요! 클라이언트가 리소스를 식별한다. `/members/{id}`
    - 클라이언트가 리소스 위치를 알고 URI를 지정한다. (POST와의 차이)

### PATCH

```text
PATCH /members/100 HTTP/1.1
Content-Type: application/json

{
    "age":50
}
```

- 리소스 부분 변경
- 간혹 PATCH를 지원하지 않는 서버 같은 경우 POST를 사용하면 된다.

### DELETE

```text
DELETE /members/100 HTTP/1.1
Host: localhost:8000
```

- 리소스 제거

## HTTP 메서드 속성

- 안전(Safe Methods)
- 멱등(Idempotent Methods)
- 캐시가능(Cacheable Methods)

### 안전(Safe)

- 호출해도 리소스를 변경하지 않는다. (GET)
    - POST, PUT, PATCH, DELETE는 리소스의 변경이 일어난다. 따라서 안전하지 않다.

> - Q: 계속 호출해서, 로그 같은가 쌓여 장애가 발생한다면?
> - A: 안전은 리소스가 기준이다. 해당 부분까지 고려하지 않는다.

### 멱등(Idempotent)

- f(f(x)) = f(x)
- 한 번 호출하든 두 번 호출하든 100번 호출하든 결과가 같다.
- 멱등 메서드(같은 요청을 보낸다는 것을 가정한다.)
    - GET: 한 번 조회하든, 여러번 조회하든 결과는 동일하다.
    - PUT: 결과를 대체한다. 같은 요청을 계속 보내도 최종 결과는 같다.
    - DELETE: 결과를 삭제한다. 같은 요청을 여러번 보내도 삭제된 결과는 같다.
- POST: 멱등하지 않다. 두 번 호출하면 같은 결제가 중복해서 발생할 수 있다.


- 활용
    - 자동 복구 메커니즘
    - 서버가 TIMEOUT 등으로 정상 응답을 못 주었을 때, 클라이언트가 같은 요청을 다시 해도 되는가? 에 판단 근거가 된다.

> - Q: 재요청 중간에 다른 곳에서 리소스를 변경한다면?
> - A: 멱등은 외부 요인으로 중간에 리소스가 변경되는 것 까지는 고려하지 않는다.

### ✅ 캐시가능(Cacheable)

- 응답 결과 리소스를 캐시해서 사용해도 되는가? (예: 이미지)
- GET, HEAD, POST, PATCH 캐시 가능
- 실제로는 GET, HEAD 정도만 캐시로 사용
- POST, PATCH는 본문 내용까지 캐시 키로 고려해야 되는데, 구현이 쉽지 않다.

> 실무에서는 주로 GET만 사용한다.